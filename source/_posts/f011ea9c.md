---
title: ä½¿ç”¨æŒç»­é›†æˆï¼ˆCIï¼‰å¼€å‘é¡¹ç›®
date: '2018/06/09 10:22:34'
updated: '2018/06/15 12:34:43'
categories: åˆ†äº«å¢ƒ
tags:
  - CI
  - æŒç»­é›†æˆ
copyright: true
abbrlink: f011ea9c
thumbnail: https://ae01.alicdn.com/kf/HTB15F15adfvK1RjSspo762fNpXaC.png
---

æˆ‘çš„åšå®¢åœ¨å»ºç«™åä¸ä¹…å°±ä½¿ç”¨äº† [Travis CI](https://travis-ci.org/) è‡ªåŠ¨éƒ¨ç½²æœåŠ¡ï¼Œå³æˆ‘åªéœ€è¦å°†ä¿®æ”¹çš„æºç æ¨é€è‡³ GitHubï¼ŒTravis CI ä¼šè‡ªåŠ¨å°†æˆ‘æäº¤çš„ä»£ç æ‹‰å–ï¼Œåœ¨ Travis CI ç«¯ç”Ÿæˆé™æ€æ–‡ä»¶åï¼ŒåŒæ­¥è‡³æˆ‘çš„æœåŠ¡å™¨ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸€äº›éº»çƒ¦çš„æ­¥éª¤ï¼šå¯ä»¥ç›´æ¥åœ¨ GitHub ç«¯ä¿®æ”¹ä»£ç ï¼›ä¸ç”¨ç­‰å¾…ç”Ÿæˆé™æ€æ–‡ä»¶ã€å‹ç¼©é™æ€æ–‡ä»¶çš„æ—¶é—´ã€‚<!--more-->

## Circle CI

è™½ç„¶ä½¿ç”¨ Travis CI æ˜¯èƒ½ç®€åŒ–éƒ¨åˆ†å¼€å‘æµç¨‹ï¼Œä½†è¿™è´§å’Œ GitHub æ˜¯ä¸€å¯¹ä¸€çš„ï¼Œåªæ”¯æŒåœ¨ GitHub æ‰˜ç®¡çš„é¡¹ç›®ï¼Œå¹¶ä¸æ”¯æŒ Bitbucket å’Œ GitLabï¼Œè€Œ GitHub å…è´¹ç‰ˆåœ¨ç§äººä»“åº“è¿™ä¸€æ–¹é¢æ˜¯æ¯”ä¸ä¸Š Bitbucket å’Œ GitLab çš„ï¼ˆè™½ç„¶æˆ‘æ˜¯å­¦ç”Ÿï¼Œå¯ä»¥ä½¿ç”¨ GitHub ç§äººä»“åº“ï¼Œå¯æˆ‘ä¹Ÿä¸ä¸€ç›´æ˜¯å­¦ç”Ÿå‘€ï¼‰ï¼ŒåŒæ—¶æ”¯æŒ Bitbucket çš„å’Œ GitHub ç§äººä»“åº“çš„ CI å·¥å…·ï¼ˆè‡ªå»ºçš„é™¤å¤–ï¼‰å¥½åƒçœŸçš„ä¹Ÿå°± [CircleCI](https://circleci.com/) äº†ï¼Œè¿™é‡Œä¹‹æ‰€ä»¥æ²¡æœ‰è€ƒè™‘ GitLab æ˜¯å› ä¸º GitLab è‡ªå¸¦æœ‰ CI/CDï¼Œè€Œä¸”è¿™å®¶å…¬å¸ç»™æˆ‘çš„å°è±¡å®åœ¨ä¸å¤ªå¥½ï¼ˆåŒ…æ‹¬ä¹‹å‰çš„åˆ åº“äº‹ä»¶ï¼Œä»¥åŠè«åå¥‡å¦™çš„ Bugï¼‰ã€‚

åœ¨äº†è§£ CircleCI åå‘ç°æ¯” Travis CI çœŸæ˜¯å¼ºä¸å°‘ï¼ˆCircleCI æ˜¯åŸºäº Docker å’Œ Workflows è®¾å®šæ¨¡å¼çš„ï¼‰ï¼Œä¸è¿‡åœ¨ç½‘ä¸Šå¹¶æ²¡æœ‰å¾ˆå®Œå–„çš„ä¸­æ–‡æ•™ç¨‹~~ï¼ˆè™½ç„¶å®˜æ–¹è‹±æ–‡æ–‡æ¡£å·²ç»å¾ˆå®Œå–„äº†ï¼‰~~ã€‚æ‰€ä»¥å¦‚æœä½ æ‡’å¾—ç¿»å®˜æ–¹æ–‡æ¡£çš„è¯ï¼Œç»§ç»­å¾€ä¸‹çœ‹æˆ‘è¿™ç¯‡æ–‡ç« å°±å¥½äº†ğŸ¤“ã€‚

## é€‰æ‹©ä»“åº“

CircleCI æ”¯æŒ GitHub å’Œ Bitbucket å¸å·çš„ç™»å½•ï¼Œæˆæƒç™»å½•å®Œæˆåï¼Œå°±å¯ä»¥æ·»åŠ  Projects äº†ï¼Œæ”¯æŒ GitHub å’Œ Bitbucket çš„å…¬æœ‰åŠç§æœ‰ä»“åº“ã€‚è¿™é‡Œä»¥æˆ‘çš„ [Meme-generator](https://github.com/WincerChan/Meme-generator) ä»“åº“ä¸ºä¾‹ã€‚

é€‰å®Œä»“åº“åï¼Œå°±å¯ä»¥å¼€å§‹é…ç½® CircleCI äº†ã€‚

## å‡†å¤‡å·¥ä½œ

### æ·»åŠ  SSH å¯†é’¥

[Meme-generator](https://github.com/WincerChan/Meme-generator) ä»“åº“ç”¨åˆ° SSH å¯†é’¥çš„åœ°æ–¹æœ‰ä¸¤å¤„ï¼š

1. ä» GitHub å…‹éš†ä»“åº“
2. å°†ç¼–è¯‘åçš„é™æ€æ–‡ä»¶æ¨é€è‡³æˆ‘çš„æœåŠ¡å™¨

å¦‚æœä½ æ˜¯ç”¨æ¥æ¨é€è‡³ GitHub çš„è¯ï¼Œå¯ä»¥ç›´æ¥ç”¨ GitHub æä¾›ä¸ºè¯¥ä»“åº“æä¾›çš„ Token å¯†é’¥ï¼Œç¬¬ä¸€ç‚¹ä¹Ÿå¯ä»¥ä½¿ç”¨ HTTPS æ–¹å¼å…‹éš†ï¼Œå°±å¯ä»¥çœå»æ·»åŠ  SSH å¯†é’¥è¿™ä¸ªæ­¥éª¤ã€‚

ç‚¹å‡» CircleCI ä¸ªäººä¸»é¡µçš„ JOBS èœå•é¡¹ï¼Œéšåç‚¹å‡»ä»“åº“åç§°å³è¾¹çš„é½¿è½®æŒ‰é’® -> ç‚¹å‡» `SSH Permissions` -> ç‚¹å‡»è“è‰²çš„ `Add SSH Key` æŒ‰é’®ï¼Œå°†**ç§é’¥**ï¼ˆçœ‹æ¸…æ¥šäº†ï¼Œæ˜¯ç§é’¥ï¼‰ç²˜è´´è¿›å»ï¼ˆè¶…çº§è‰¯å¿ƒæœ‰æœ¨æœ‰å•Šï¼Œæ¯” Travis CI å°†ç§é’¥åŠ å¯†ä¸Šä¼ è¿™ç§åœŸåŠæ³•ä¸çŸ¥é“é«˜åˆ°å“ªé‡Œå»äº†ï¼‰ã€‚

### æ·»åŠ  IP è‡³ known\_hosts

æ·»åŠ  SSH å¯†é’¥åï¼Œè¿˜éœ€è¦å°†æœåŠ¡å™¨çš„ IP æ·»åŠ è‡³ known_hosts åˆ—è¡¨ï¼Œå¦åˆ™æ¯æ¬¡éƒ¨ç½²çš„æ—¶å€™éƒ½ä¼šè®©ä½ ç¡®è®¤ä»¥ä¸‹æ¶ˆæ¯ï¼š

```bash
The authenticity of host 'Ã—Ã—.Ã—Ã—Ã—.Ã—Ã—Ã—.Ã—Ã—Ã—' can't be established.
ECDSA key fingerprint is SHA256:7hkfahfla8VeiuyF/TLHKfhakgcJ0sHjaLxDyIKlfhak9fuaofoa.
Are you sure you want to continue connecting (yes/no)?
```

åŒ Travis CI ç±»ä¼¼ï¼ŒCircleCI åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ä¹Ÿæ˜¯ä¸æ¥å—å‘½ä»¤è¡Œè¾“å…¥çš„ï¼ˆå½“ç„¶è¿è¡Œå®Œæˆåå°±æ›´ä¸è¡Œäº†ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æå‰å°† IP å†™å…¥ known\_hostsï¼ˆåœ¨ CircleCI ä¸­å¦‚ä½•åšï¼Ÿç»§ç»­å¾€åçœ‹ï¼‰ï¼š

```bash
ssh-keyscan $SSH_IP >> ~/.ssh/known_hosts
```

åœ¨è¯¥ä»“åº“çš„ç®¡ç†é¡µé¢ä¸­çš„ `Environment Variables` é€‰é¡¹å¡ä¸­æ·»åŠ  SSH_IP çš„ç¯å¢ƒå˜é‡ã€‚

## é…ç½®æ–‡ä»¶

### ç®€å•çš„ä¾‹å­

ç”±äºæˆ‘çš„é…ç½®æ–‡ä»¶å¤ªè¿‡é•¿äº†ï¼Œå…ˆä»¥ä¸€ä¸ªç®€åŒ–ç‰ˆä¸ºä¾‹ï¼š

```yaml
version: 2
jobs:
  build:
    docker:
      - image: circleci/node:10.4.0
    steps:
      - checkout
      - run:
          name: Install Dependence
          command: |
            yarn install && yarn build
      - run:
      	  name: Deploy
      	  command: |
      	    echo "Denpendence installed."
```

é¦–å…ˆæŒ‡æ˜ CircleCI çš„ç‰ˆæœ¬å·â€”â€”2.0ï¼ˆ1.0 åœ¨ 18 å¹´ 9 æœˆä¹‹åå°±åœæ­¢æ”¯æŒäº†ï¼‰ã€‚

å…¶æ¬¡ï¼Œä¸º Docker æŒ‡å®š imageï¼ˆ[è¿™æ˜¯](https://circleci.com/docs/2.0/circleci-images/)å®˜æ–¹å·²ç»æ„å»ºå®Œæˆçš„é•œåƒåˆ—è¡¨ï¼‰ï¼Œå¯ä»¥æŒ‡å®šå¤šä¸ª imageã€‚å…ˆå‰æåˆ°è¿‡ï¼ŒCircleCI å¹¶ä¸é»˜è®¤åƒ Travis CI é‚£æ ·æä¾› Linux è™šæ‹Ÿæœºé•œåƒï¼Œæ¨èä½¿ç”¨çš„æ˜¯ Dockerï¼ˆå½“ç„¶ä½ ä¹Ÿå¯ä»¥æŒ‡å®šå·¥ä½œæ–¹å¼ä¸º Machineï¼‰ï¼Œè¿™æ˜¯å®˜æ–¹é’ˆå¯¹ Docker å’Œ Machine çš„[å¯¹æ¯”æŠ¥å‘Š](https://circleci.com/docs/2.0/executor-types/#overview)ã€‚

éšååœ¨ `steps` é‡Œé¢æ˜¯éœ€è¦è¿è¡Œçš„æŒ‡ä»¤ï¼š

1. `checkout` æ˜¯ä¸€ä¸ªç”¨äºæ£€æŸ¥é…ç½®è·¯å¾„çš„æºä»£ç çš„ç‰¹æ®Šæ­¥éª¤ï¼Œå¹¶å¯ä»¥é€šè¿‡ SSH æ¥ clone è¿œç¨‹ä»“åº“çš„ä»£ç ï¼ˆå¦‚æœä½ å·²ç»æ·»åŠ äº† SSH ç§é’¥çš„è¯ï¼Œä¸ç„¶å°±åªå¥½æ‰‹åŠ¨ clone äº†ï¼‰ï¼Œè¯¦è§£è§[å®˜æ–¹æ–‡æ¡£](https://circleci.com/docs/2.0/configuration-reference/#checkout)
2. `run:` åé¢æ¥çš„æ˜¯ bash å‘½ä»¤ï¼Œ`name` è¯¥ä»»åŠ¡çš„åç§°ï¼Œ`command` ä¸ºå…·ä½“ bash çš„æŒ‡ä»¤

### å®‰è£…é¢å¤–å‘½ä»¤

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½ éœ€è¦å°†ç”Ÿæˆçš„é™æ€æ–‡ä»¶åŒæ­¥è‡³æœåŠ¡å™¨æ‰€ç”¨çš„ `rsync` å‘½ä»¤æ˜¯æ²¡æœ‰è¢«å®‰è£…çš„ï¼Œåªæœ‰[è¿™äº›å‘½ä»¤](https://circleci.com/docs/2.0/circleci-images/#pre-installed-tools)æ˜¯è¢«å®‰è£…åœ¨æ‰€æœ‰é•œåƒä¸­çš„ã€‚

docker é•œåƒé¢„è£…çš„ç³»ç»Ÿæ˜¯ Ubuntuï¼Œå¯é‡‡å– `apt-get` å‘½ä»¤æ¥å®‰è£…éœ€è¦çš„è½¯ä»¶åŒ…ï¼š

```yaml
run: 
  name: Update System
  command: |
    sudo apt-get update && sudo apt-get install rsync
```

### è®¾ç½®ç¼“å­˜

CircleCI å»ºè®®çš„ Workflows ä¸­å»ºè®®å°†æ•´ä¸ªå·¥ä½œæµåˆ†å‰²æˆä¸åŒçš„å­ä½œä¸šï¼Œæ¯”å¦‚è¯´ä»¥ Yarn é¡¹ç›®ä¸ºä¾‹ï¼Œå¯ä»¥åˆ†æˆ `build` å’Œ `deploy` ä¸¤ä¸ªæµç¨‹ã€‚å…¶ä¸­ `build` ç”¨ä»¥å®‰è£…ä¾èµ–å’Œç”Ÿæˆå¾…éƒ¨ç½²çš„é™æ€æ–‡ä»¶ï¼›`deploy` ç”¨ä»¥å°†ç”Ÿæˆçš„é™æ€æ–‡ä»¶éƒ¨ç½²è‡³æœåŠ¡å™¨ã€‚

å¯ä»¥çœ‹å‡ºï¼Œé™æ€æ–‡ä»¶æ˜¯æ¨ªè·¨ä¸¤ä¸ªä½œä¸šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†åŒ…å«é™æ€æ–‡ä»¶çš„æ–‡ä»¶å¤¹ç¼“å­˜ä¸‹æ¥ï¼ˆå½“ç„¶ä½ ä¹Ÿå¯ä»¥é€‰æ‹©ä¸ä½¿ç”¨ Workflowsï¼Œè¿™æ ·å°±åªéœ€åˆ›å»ºä¸€ä¸ªå·¥ä½œå°±å¥½äº†ï¼‰ï¼Œåœ¨ `build` å·¥ä½œä¸­ç¼“å­˜é‡‡å–å¦‚ä¸‹å‘½ä»¤ï¼š

```yaml
steps:
  - restore_cache:
    keys:
      - build-v1-{{ checksum "package.json" }}
    paths:
      - "build"
```

ä»¥ä¸Šå‘½ä»¤æ˜¯å°† `build` æ–‡ä»¶å¤¹ä»¥ `key-value` å½¢å¼ç¼“å­˜ï¼Œå…¶ä¸­ `key` é€‰æ‹©çš„æ˜¯ `package.json` çš„å“ˆå¸Œå€¼ã€‚è¿™é‡Œçš„æ–‡ä»¶åæœ€å¥½é€‰æ‹©ä»“åº“è‡ªå¸¦çš„æ–‡ä»¶ã€‚æ›´å¤š `key` çš„å½¢å¼å¯ä»¥å‚è€ƒ[è¿™é‡Œ](https://circleci.com/docs/2.0/caching/#using-keys-and-templates)ã€‚

åœ¨ `deploy` å·¥ä½œä¸­æ¢å¤ç¼“å­˜é‡‡å–ä»¥ä¸‹å‘½ä»¤ï¼š

```yaml
steps:
  - checkout
  - restore_cache:
    keys:
      - meme-v1-{{ checksum "package.json" }}
```

æ³¨æ„åœ¨ `restore_cache` ä¹‹å‰ä¸€å®šè¦æœ‰ `checkout` å‘½ä»¤ã€‚

### å®Œæ•´çš„ç¤ºä¾‹

ç›´æ¥æ”¾ [Meme-generator](https://github.com/WincerChan/Meme-generator) é¡¹ç›®çš„é…ç½®ä»£ç äº†ï¼š[ç‚¹æˆ‘](https://gist.github.com/WincerChan/04b5e1ee8a1fbc8bc2e078d2c354bd7b)ã€‚

æ¯æ¬¡æ„å»ºå®Œæˆåï¼Œcommits åˆ—è¡¨çš„ç”»é£å°±å˜æˆè¿™æ ·äº†ï¼š

![CircleCI æ„å»º](https://res.cloudinary.com/wincer/image/upload/v1530858045/blog/ci_project/circleci_construction.png)

ç‚¹å‡» Details å°±ä¼šæ˜¾ç¤ºæ¯æ¬¡æ„å»ºçš„è¯¦ç»†è¿‡ç¨‹ã€‚

## åè®°

è™½ç„¶æœ¬æ–‡åä¸ºã€Œä½¿ç”¨æŒç»­é›†æˆï¼ˆCIï¼‰å¼€å‘é¡¹ç›®ã€ï¼Œä½†å®é™…å´å¥½åƒåªä»‹ç»äº† CircleCIï¼Œå½“ç„¶æˆ‘çš„æ„æ€ä¸æ˜¯é’¦å®š CircleCI ä½œä¸ºæœ€å¥½çš„æŒç»­é›†æˆç³»ç»Ÿï¼Œæˆ‘æ²¡æœ‰è¯´ CircleCI æ˜¯æœ€å¥½çš„æŒç»­é›†æˆç³»ç»Ÿï¼Œæ²¡æœ‰ä»»ä½•è¿™ä¸ªæ„æ€ã€‚ä½†ä½ ä¸€å®šè¦é—®æˆ‘ä¸ºä»€ä¹ˆé€‰ CircleCIï¼Œå®ƒç°åœ¨å¯¹ Bitbucket å’Œ GitHub çš„ç§äººä»“åº“æ”¯æŒæœ€å®Œå–„ï¼Œæˆ‘æ€ä¹ˆèƒ½ä¸æ”¯æŒå®ƒå‘¢ï¼Ÿ

å‚è€ƒï¼š

- [2.0 Docs](https://circleci.com/docs/2.0/)
